const e=new Intl.Collator(void 0,{usage:"sort",sensitivity:"base",ignorePunctuation:!0,numeric:!0}),t=e=>{if(ui?.windows)for(const t of Object.values(ui.windows))t?.rendered&&"ActorSheet"===t?.options?.baseApplication&&e(t)},s=/^[a-z_][a-z0-9\-_]*[a-z0-9_]$/i,o=e=>{if(!s.test(e))throw new Error('CSS prefixes must be at least two characters, start and end with a letter or "_", and contain only letters, numbers, "_", or "-"')};class r{#e;constructor(e){o(e),this.#e=`${e}--`}child(e){return o(e),`${this.#e}${e}`}childPrefix(e){return o(e),new r(this.child(e))}}class n{#t;#s;#o;#r;#n;constructor(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"#4f0104";this.#t=e,this.#n=t,this.#s=s,this.#o=`%c${e}`,this.#r=`background-color: ${s}; color: #fff; padding: 0.1em 0.5em;`}child(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.#s;return new n(`${this.#t} - ${e}`,this.#n,t)}debug(){if(this.#n.debug){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];console.debug(this.#o,this.#r,...t)}}info(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];console.info(this.#o,this.#r,...t)}warn(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];console.warn(this.#o,this.#r,...t)}error(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];console.error(this.#o,this.#r,...t)}}const i=Array.isArray;let a=!1;const l=[];let c;Hooks.once("init",(()=>{a=!0;for(const e of l)e();c?.()}));class g{#i;#a;constructor(e,t){this.#i=e,this.#a=t}registerMenu(e,t){const s={...t,name:`${this.#i}.setting.menu.${e}.name`,label:`${this.#i}.setting.menu.${e}.label`,hint:`${this.#i}.setting.menu.${e}.hint`},o=()=>{game.settings.registerMenu(this.#i,e,s)};return a?o():l.push(o),{id:`${this.#i}--menu--${e}`,title:`${this.#i}.setting.menu.${e}.title`,template:`modules/${this.#i}/templates/menu-${e}.html`}}#l(e,t){let s;return t&&(s=i(t)?{choices:Object.fromEntries(t.map((t=>[t,this.#a(`setting.${e}.choice.${t}`)])))}:{choices:Object.fromEntries(Object.entries(t).map((e=>[e[0],"function"==typeof e[1]?e[1]():e[1]])))}),s}register(e,t,s){let{scope:o="world",hasHint:r,config:n=!0,requiresReload:i=!1,choices:g,callOnChangeOnInit:d,onChange:u,...h}=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const m={set:t=>{game.settings.set(this.#i,e,t)},get:()=>game.settings.get(this.#i,e)},p=()=>{const a=this.#l(e,g);game.settings.register(this.#i,e,{name:this.#a(`setting.${e}.label`),hint:r?this.#a(`setting.${e}.hint`):void 0,config:"function"==typeof n?n():n,scope:o,type:t,default:s,requiresReload:i,onChange:u,...a,...h}),d&&u?.(m.get())};return a?p():"debug"===e?c=p:l.push(p),m}registerKeybinding(e,t,s){let{hasHint:o,defaultKeybindings:r,precedence:n=foundry.CONST.KEYBINDING_PRECEDENCE.NORMAL,...i}=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const c=()=>{game.keybindings.register(this.#i,e,{name:this.#a(`hotkey.${e}.label`),hint:o?this.#a(`hotkey.${e}.hint`):void 0,editable:r??[],onDown:t,onUp:s,precedence:n,...i})};a?c():l.push(c)}}class d{#c;constructor(e){this.#c=`module.${e}`}emit(e){if(!game.socket)throw new Error("emit was called before game.socket was initialized or after it was torn down");game.socket.emit(this.#c,e)}on(e){if(!game.socket)throw new Error("on was called before game.socket was initialized or after it was torn down");game.socket.on(this.#c,e)}}class u{#g;constructor(e,t){this.#g=`modules/${e}/templates/${t}`,Hooks.on("init",(()=>{getTemplate(this.#g)}))}async render(e){return await renderTemplate(this.#g,e)}}const h=new class{#d;#u;#h;#m;#p=!1;constructor(e){let{id:t,title:s,version:o,bugs:r,color:i}=e;const a=this.localize.bind(this);this.localize=a,this.#d=t,this.#h=new g(t,a);const l={debug:!1};this.#h.register("debug",Boolean,!1,{scope:"client",hasHint:!0,callOnChangeOnInit:!0,onChange:e=>{l.debug=e}}),this.#u=new n(`${s} v${o}`,l,i),r?this.logger.info(`Started. To report bugs, go to: ${r}`):this.logger.info("Started")}get id(){return this.#d}get logger(){return this.#u}get cssPrefix(){return this.#m||(this.#m=new r(this.#d)),this.#m}get settings(){return this.#h}localize(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const o=`${this.#d}.${e}`;if(!0!==s||game.i18n.has(o))return t?game.i18n.format(o,t):game.i18n.localize(o)}registerTemplate(e){return new u(this.#d,e)}initializeSocket(){if(this.#p)throw new Error("Socket should only be initialized once (to ensure the same generic type is used for all socket messages sent by this module, since they will all use the same message key)");return this.#p=!0,new d(this.#d)}}({id:"illandril-inventory-sorter",version:"3.1.3",title:"Illandril's Inventory Sorter (5e)",bugs:"https://github.com/illandril/FoundryVTT-inventory-sorter/issues"}),m=[],p=[],f=e=>{p.push(e)},y=()=>{for(const e of m)e()},b=()=>{for(const e of p)e()},$="name",k="none",w="default",S=e=>{if(e===k)return null;const[t,s]=e.split("_");return{column:t,isDesc:"desc"===s}},v=(e,t)=>{let s=e();return s===w&&(s=t()),S(s)},C=e=>{const t=[$,...e].flatMap((e=>[[`${e}_asc`,`${h.id}.setting.sort.choice.${e}_asc`],[`${e}_desc`,`${h.id}.setting.sort.choice.${e}_desc`]]));return t.push(),Object.fromEntries([[k,`${h.id}.setting.sort.choice.${k}`],...t])},I=(e,t)=>{const s=C(t),o=h.settings.register(`sort${e}FallbackPrimary`,String,`${$}_asc`,{scope:"client",hasHint:!0,choices:s,onChange:y}),r=h.settings.register(`sort${e}FallbackSecondary`,String,k,{scope:"client",hasHint:!0,choices:s,onChange:y});return{type:e,choices:t,setPrimary:o.set,primary:o.get,setSecondary:r.set,secondary:r.get}},P=(e,t,s)=>{const o={[w]:`${h.id}.setting.sort.choice.default`,...C([...s,...t.choices])},r=h.settings.register(`sort${t.type}${e}Primary`,String,w,{scope:"client",choices:o,onChange:y}),n=h.settings.register(`sort${t.type}${e}Secondary`,String,w,{scope:"client",choices:o,onChange:y});return{setPrimary:r.set,primary:()=>v(r.get,t.primary),setSecondary:n.set,secondary:()=>v(n.get,t.secondary)}},z=(e,t)=>P(e,t,[]),E=I("Inventory",["weight","totalWeight","quantity","usage"]),_=z("Weapons",E),x=z("Equipment",E),A=z("Consumables",E),O=z("Tools",E),q=z("Backpacks",E),H=z("Loot",E),T=I("Features",[]),N=z("Race",T),D=z("Background",T),L=z("Class",T);var U;const j={base:void 0,weapon:_,equipment:x,consumable:A,tool:O,backpack:q,loot:H,race:N,background:D,class:L,subclass:L,feat:P("Other",T,["requirements","usage"]),spell:(U=I("Spells",["usage","school","target"]),{setPrimary:e=>{U.setPrimary(e)},primary:()=>S(U.primary()),setSecondary:e=>{U.setSecondary(e)},secondary:()=>S(U.secondary())})},B=h.settings.register("enableLegacySorter",Boolean,!1,{hasHint:!0,onChange:()=>{y(),b()}}),R=h.settings.register("sortFeatsByRequirement",Boolean,!1,{hasHint:!0,onChange:b}),F=(e,t)=>{if(null===t)return null;let s;const o=e.system.quantity??0,r=e.system.weight??0;switch(t.column){case"name":s=e.name;break;case"quantity":s=`${o}`;break;case"usage":s=(e=>{const t=e.system.activation,s=t?.type||"";return`${1e6*(Object.keys(dnd5e.config.abilityActivationTypes).indexOf(s)+1)+(t?.cost||0)}`})(e);break;case"weight":s=`${r}`;break;case"totalWeight":s=""+r*o;break;case"school":s=e.system.school??"";break;case"target":s=(e=>{const t=e.system.target,s=t?.type||"";return`${1e6*(Object.keys(dnd5e.config.targetTypes).indexOf(s)+1)+(t?.value||0)}`})(e);break;case"requirements":s=e.system.requirements??"";break;default:return h.logger.error("Unexpected sort setting",t),null}return{value:s,isDesc:t.isDesc}},K=e=>j[e.type],M=[e=>F(e,K(e)?.primary()??null),e=>F(e,K(e)?.secondary()??null)],W=e=>{const t=[];for(const s of e.querySelectorAll(".item-list")){const e=[];for(const t of s.querySelectorAll(".item")){const s=t.getAttribute("data-item-id");s&&e.push({id:s,element:t})}t.push({items:e,element:s,referenceNode:null})}return t};W.key="generic";const G=e=>{if(!e?.classList.contains("tidy5e-kgar")&&!e?.classList.contains("tidy5e-sheet"))return null;const t=[];for(const s of e.querySelectorAll('[data-tidy-sheet-part="item-table"]')){const e=[],o=s.querySelector("[data-item-id]")?.parentElement;if(!o)continue;const r=o.querySelector("[data-item-id] + :not([data-item-id])");for(const t of o.querySelectorAll("[data-item-id]")){const s=t.getAttribute("data-item-id");e.push({id:s,element:t})}t.push({element:o,items:e,referenceNode:r})}return t};G.key="tidy5e-sheet";const Y=[G,W],V=(e,t,s)=>{const o=e.items.get(t.id);return{...t,sorts:[...M.map((e=>o?e(o):null)),{value:`${o?.sort||""}`,isDesc:!1},{value:`${o?.id||""}`,isDesc:!1},{value:`${s}`,isDesc:!1}]}},J=(t,s)=>{for(let o=0;o<t.sorts.length;o++){const r=t.sorts[o],n=s.sorts[o],i=e.compare(r?.value??"",n?.value??"");if(i)return r?.isDesc||n?.isDesc?-1*i:i}return 0},Q=e=>{if(B.get())return;const t=e.element.get(0),s=foundry.utils.getProperty(e,"actor");t&&s?X(t,s):h.logger.debug("Not sorting sheet - no sheet element or no actor",e,t,s)},X=(e,t)=>{for(const s of Y){h.logger.debug("Checking itemFinder",s.key);const o=s(e);if(o?.length){h.logger.debug("Found sections",s.key,o.length);for(const e of o){const s=e.items.map(((e,s)=>V(t,e,s)));s.sort(J),h.logger.debug("Sorted list",s);for(const t of s)e.element.insertBefore(t.element,e.referenceNode)}return void h.logger.debug("Done sorting sheet",e,t)}}h.logger.debug("Could not sort sheet - no sections found",e,t)};Hooks.on("renderActorSheet",(e=>{Q(e)})),Hooks.on("renderContainerSheet",(e=>{Q(e)})),Hooks.on("tidy5e-sheet.renderActorSheet",(e=>{Q(e)})),Hooks.on("updateUser",((e,t)=>{e.id===game.user?.id&&foundry.utils.getProperty(t,"flags.dnd5e.sheetPrefs")&&setTimeout((()=>{Z()}),1)}));const Z=()=>{B.get()||t(Q)};var ee;ee=Z,m.push(ee);const te=t=>{if(!t)return[];return(t=>t.map((e=>e)).sort(((t,s)=>e.compare(t.group,s.group)||e.compare(t.alternateSort,s.alternateSort)||e.compare(t.name,s.name)||e.compare(t.id,s.id))).map((e=>({id:e.id,group:e.group}))))(t.map((e=>{const t=e.type,s=e.name;let o,r;if("spell"===t)o=(e=>{const t=e.preparation?.mode;let s;return s="atwill"===t||"innate"===t||"pact"===t?t:`${e.level||0}`,s})(e.system);else if("feat"===t){const t=(e=>{let t,s;return t=e.activation&&e.activation.type?"active":"passive",R.get()&&(s=e.requirements),{subtype:t,alternateSort:s}})(e.system);o=t.subtype,r=t.alternateSort}return{id:e.id,group:o?`${t}_${o}`:t,name:s,alternateSort:r??""}})))},se=e=>{const t=new Map;if(e){const s=te(e.items);let o=0,r=null;for(const e of s){e.group!==r&&(o=0,r=e.group),o++;const s=o*foundry.CONST.SORT_INTEGER_DENSITY;t.set(e.id,{_id:e.id,sort:s})}}return t},oe=new Set;f((()=>{oe.clear()}));const re=new Map,ne=e=>{e&&(clearTimeout(re.get(e.id)),re.set(e.id,setTimeout((()=>{(async e=>{oe.add(e.id);const t=se(e),s=[];for(const o of t.values())e.items.get(o._id).sort!==o.sort&&s.push(o);if(s.length>0){h.logger.debug("Updating sort for items",s);try{await e.updateEmbeddedDocuments("Item",s,{illandrilInventorySorterUpdate:!0})}catch(t){h.logger.error("Error updating items for actor",e.id,t)}}})(e)}),150)))},ie=e=>e.actor,ae=(e,t)=>{B.get()&&t===game.userId&&ne(ie(e))},le=e=>{if(e.isEditable){const t=e.actor;(e=>oe.has(e.id))(t)||ne(t)}};Hooks.on("renderActorSheet",(e=>{B.get()&&le(e)})),Hooks.on("createItem",((e,t,s)=>ae(e,s))),Hooks.on("deleteItem",((e,t,s)=>ae(e,s))),Hooks.on("updateItem",((e,t,s,o)=>{s.illandrilInventorySorterUpdate||ae(e,o)})),Hooks.on("preUpdateItem",((e,t,s)=>{if(!B.get())return!0;if(void 0===t.sort)return!0;if(void 0===t._id)return h.logger.error("preUpdateItem hook was called with no _id",t),!0;if(!s.illandrilInventorySorterUpdate){const s=se(ie(e)).get(t._id);s&&(t.sort=s.sort)}return e.sort!==t.sort||2!==Object.keys(t).length}));f((()=>{B.get()&&t(le)}));
